# æ—¥å¿—ç®¡ç†ç³»ç»Ÿ (Log Manager)

æ—¥å¿—ç®¡ç†ç³»ç»Ÿç”¨äºæ¥æ”¶å’Œç®¡ç†æ¥è‡ª `log-filter-monitor` ä¸ŠæŠ¥çš„æ—¥å¿—å’ŒæŒ‡æ ‡æ•°æ®ï¼Œæä¾›ç»Ÿä¸€çš„ç®¡ç†åå°ç•Œé¢ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ“ **æ—¥å¿—æ¥æ”¶ä¸ç®¡ç†**ï¼šæ”¯æŒ HTTPã€UDPã€TCP å¤šç§æ–¹å¼æ¥æ”¶æ—¥å¿—ï¼ŒæŒ‰æ ‡ç­¾ã€è§„åˆ™åç§°ã€å…³é”®è¯ã€æ—¶é—´èŒƒå›´ç­‰æ¡ä»¶æŸ¥è¯¢
- ğŸ“Š **æŒ‡æ ‡ç»Ÿè®¡å±•ç¤º**ï¼šå±•ç¤ºå„é¡¹ç›®çš„æŒ‡æ ‡ç»Ÿè®¡æ•°æ®ï¼ŒåŒ…æ‹¬è§„åˆ™åŒ¹é…è®¡æ•°ã€æ€»è®¡æ•°ç­‰
- ğŸ’° **è®¡è´¹ç»Ÿè®¡**ï¼šé…ç½®è®¡è´¹è§„åˆ™ï¼ŒæŒ‰æ—¥èšåˆè®¡è´¹æ•°æ®
- ğŸ·ï¸ **æ ‡ç­¾åˆ†ç±»**ï¼šé€šè¿‡æ ‡ç­¾åŒºåˆ†ä¸åŒé¡¹ç›®ä¸ŠæŠ¥çš„æ—¥å¿—å’ŒæŒ‡æ ‡
- ğŸ” **å¼ºå¤§çš„æŸ¥è¯¢åŠŸèƒ½**ï¼šæ”¯æŒå¤šæ¡ä»¶ç»„åˆæŸ¥è¯¢ï¼Œå¿«é€Ÿå®šä½ç›®æ ‡æ—¥å¿—
- ğŸ¨ **ç°ä»£åŒ– UI**ï¼šåŸºäº React + Ant Design æ„å»ºçš„ç¾è§‚æ˜“ç”¨çš„ç®¡ç†ç•Œé¢

## é¡¹ç›®ç»“æ„

```
log-manager/
â”œâ”€â”€ backend/              # åç«¯æœåŠ¡ï¼ˆGoï¼‰
â”‚   â”œâ”€â”€ config.yaml      # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ go.mod           # Go ä¾èµ–ç®¡ç†
â”‚   â”œâ”€â”€ main.go          # å…¥å£æ–‡ä»¶
â”‚   â””â”€â”€ internal/
â”‚       â”œâ”€â”€ app/         # åº”ç”¨åˆå§‹åŒ–
â”‚       â”œâ”€â”€ config/      # é…ç½®ç®¡ç†
â”‚       â”œâ”€â”€ database/    # æ•°æ®åº“è¿æ¥
â”‚       â”œâ”€â”€ handler/     # HTTP å¤„ç†å™¨
â”‚       â””â”€â”€ models/      # æ•°æ®æ¨¡å‹
â””â”€â”€ frontend/            # å‰ç«¯åº”ç”¨ï¼ˆReactï¼‰
    â”œâ”€â”€ package.json     # ä¾èµ–ç®¡ç†
    â”œâ”€â”€ public/          # é™æ€èµ„æº
    â””â”€â”€ src/
        â”œâ”€â”€ api/         # API æ¥å£å°è£…
        â”œâ”€â”€ components/  # å…¬å…±ç»„ä»¶
        â”œâ”€â”€ pages/       # é¡µé¢ç»„ä»¶
        â”œâ”€â”€ App.js       # åº”ç”¨ä¸»ç»„ä»¶
        â””â”€â”€ index.js     # å…¥å£æ–‡ä»¶
```

## å¿«é€Ÿå¼€å§‹

### ä¸€é”®å¯åŠ¨

åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œï¼š

```bash
./start.sh          # å¼€å‘ï¼šå‰å°è¿è¡Œåç«¯+å‰ç«¯ï¼ŒCtrl+C åœæ­¢
./start.sh -d       # å¼€å‘ï¼šåå°è¿è¡Œï¼Œè¾“å‡ºå†™å…¥ logs/ï¼Œä½¿ç”¨ ./stop.sh åœæ­¢
./start.sh build    # æ‰“åŒ…å‰ç«¯åˆ° backend/webï¼Œç”¨äºç”Ÿäº§éƒ¨ç½²
./start.sh prod     # ç”Ÿäº§ï¼šä»…å¯åŠ¨åç«¯ï¼ˆæ‰˜ç®¡å‰ç«¯ï¼‰ï¼Œå•ç«¯å£ 8888ï¼Œæ— éœ€ Node.js
./start.sh prod -d  # ç”Ÿäº§ï¼šåå°è¿è¡Œ
```

å¼€å‘æ¨¡å¼ä¼šå¯åŠ¨åç«¯ï¼ˆ8888ï¼‰å’Œå‰ç«¯å¼€å‘æœåŠ¡å™¨ï¼ˆ3000ï¼‰ï¼›ç”Ÿäº§æ¨¡å¼ä»…å¯åŠ¨åç«¯ï¼Œå°†å‰ç«¯é™æ€æ–‡ä»¶ä¸€å¹¶æ‰˜ç®¡ï¼Œé€‚åˆæœåŠ¡å™¨éƒ¨ç½²ã€‚

### ç”Ÿäº§éƒ¨ç½²æµç¨‹

1. æœ¬åœ°æˆ– CI æ‰§è¡Œï¼š`./start.sh build` æ‰“åŒ…å‰ç«¯
2. å°† `backend/` ç›®å½•ï¼ˆå« `web/`ã€`config.prod.yaml`ï¼‰ä¸Šä¼ è‡³æœåŠ¡å™¨
3. æœåŠ¡å™¨æ‰§è¡Œï¼š`cd backend && CONFIG=config.prod.yaml go run main.go` æˆ–ä½¿ç”¨ `./start.sh prod`
4. è®¿é—® http://æœåŠ¡å™¨:8888/log/manager å³å¯ä½¿ç”¨

### æ‰‹åŠ¨å¯åŠ¨

**åç«¯**ï¼š`cd backend && go run main.go`ï¼ˆç«¯å£ 8888ï¼‰

**å‰ç«¯å¼€å‘**ï¼š`cd frontend && npm install && npm start`ï¼ˆç«¯å£ 3000ï¼‰

### é…ç½® log-filter-monitor

åœ¨ `log-filter-monitor` çš„é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ä¸ŠæŠ¥æ–¹å¼ã€‚**æ¨è TCP é•¿è¿æ¥**ï¼ˆé»˜è®¤ï¼Œå¯é +é«˜æ€§èƒ½ï¼‰ï¼š

```yaml
# TCP é•¿è¿æ¥ï¼ˆé»˜è®¤ï¼Œæ¨èï¼‰
handler:
  type: tcp
  tcp_addr: "manager-host:8890"
  tcp_batch_size: 200
  tcp_flush_interval: 200ms
```

å…¶ä»–æ–¹å¼ç¤ºä¾‹ï¼š

```yaml
# UDP ä¸ŠæŠ¥ï¼ˆå¯æ¥å—å°‘é‡ä¸¢åŒ…ï¼‰
# handler:
#   type: udp
#   udp_addr: "manager-host:8889"

# HTTP ä¸ŠæŠ¥
# handler:
#   type: http
#   api_url: http://manager-host:8888/log/manager/api/v1/logs
#   timeout: 10s
```

æŒ‡æ ‡ä¸ŠæŠ¥éœ€é…ç½® `metrics.api_url: http://manager-host:8888/log/manager/api/v1/metrics`ã€‚

## API æ¥å£

æ‰€æœ‰æ¥å£è·¯å¾„å‡ä»¥ `/log/manager` ä¸ºå‰ç¼€ã€‚

### æ—¥å¿—æ¥å£

#### æ¥æ”¶æ—¥å¿—
- **POST** `/log/manager/api/v1/logs`
- æ¥æ”¶å•æ¡æ—¥å¿—ä¸ŠæŠ¥

#### æ‰¹é‡æ¥æ”¶æ—¥å¿—
- **POST** `/log/manager/api/v1/logs/batch`
- æ‰¹é‡æ¥æ”¶æ—¥å¿—ï¼ˆæœ€å¤š 100 æ¡/æ¬¡ï¼‰ï¼Œé€‚ç”¨äº HTTP æ‰¹é‡æ¨¡å¼

#### æŸ¥è¯¢æ—¥å¿—
- **GET** `/log/manager/api/v1/logs`
- æŸ¥è¯¢å‚æ•°ï¼š
  - `tag`: æ ‡ç­¾ç­›é€‰
  - `rule_name`: è§„åˆ™åç§°ç­›é€‰
  - `keyword`: å…³é”®è¯æœç´¢ï¼ˆåœ¨æ—¥å¿—å†…å®¹ä¸­æœç´¢ï¼‰
  - `start_time`: å¼€å§‹æ—¶é—´æˆ³
  - `end_time`: ç»“æŸæ—¶é—´æˆ³
  - `page`: é¡µç ï¼ˆä»1å¼€å§‹ï¼‰
  - `page_size`: æ¯é¡µæ•°é‡

#### è·å–æ ‡ç­¾åˆ—è¡¨
- **GET** `/log/manager/api/v1/logs/tags`

#### è·å–è§„åˆ™åç§°åˆ—è¡¨
- **GET** `/log/manager/api/v1/logs/rule-names`

### æŒ‡æ ‡æ¥å£

#### æ¥æ”¶æŒ‡æ ‡
- **POST** `/log/manager/api/v1/metrics`
- æ¥æ”¶æ¥è‡ª log-filter-monitor çš„æŒ‡æ ‡ä¸ŠæŠ¥

#### æŸ¥è¯¢æŒ‡æ ‡
- **GET** `/log/manager/api/v1/metrics`
- æŸ¥è¯¢å‚æ•°ï¼š
  - `tag`: æ ‡ç­¾ç­›é€‰
  - `start_time`: å¼€å§‹æ—¶é—´æˆ³
  - `end_time`: ç»“æŸæ—¶é—´æˆ³
  - `page`: é¡µç ï¼ˆä»1å¼€å§‹ï¼‰
  - `page_size`: æ¯é¡µæ•°é‡

## é…ç½®è¯´æ˜

### åç«¯é…ç½® (config.yaml)

```yaml
server:
  host: "0.0.0.0"
  port: 8888           # HTTP API ä¸å‰ç«¯

database:
  type: "sqlite"       # æˆ– mysql
  dsn: "./log_manager.db"

log_retention_days: 30

# UDP æ—¥å¿—æ¥æ”¶ï¼ˆç«¯å£ 8889ï¼‰
udp:
  enabled: true
  host: "0.0.0.0"
  port: 8889

# TCP é•¿è¿æ¥æ—¥å¿—æ¥æ”¶ï¼ˆç«¯å£ 8890ï¼Œé»˜è®¤å¯ç”¨ï¼‰
tcp:
  enabled: true
  host: "0.0.0.0"
  port: 8890
  buffer_size: 50000
  flush_interval: "50ms"
  flush_size: 1000

# è®¤è¯ï¼ˆWeb ç®¡ç†ç•Œé¢ç™»å½•ï¼‰
auth:
  login_enabled: true
  admin_username: "admin"
  admin_password: "admin"  # ç”Ÿäº§ç¯å¢ƒè¯·ä¿®æ”¹

cors:
  enabled: true
  allow_origins:
    - "http://localhost:3000"
  allow_methods: [GET, POST, PUT, DELETE, OPTIONS]
  allow_headers: [Content-Type, Authorization]
```

## ä½¿ç”¨è¯´æ˜

1. **ç™»å½•**ï¼š
   - å¯ç”¨ `auth.login_enabled` æ—¶ï¼Œè®¿é—®ç®¡ç†ç•Œé¢éœ€å…ˆç™»å½•ï¼ˆé»˜è®¤ admin/adminï¼Œç”Ÿäº§ç¯å¢ƒè¯·ä¿®æ”¹å¯†ç ï¼‰

2. **æŸ¥çœ‹æ—¥å¿—**ï¼š
   - åœ¨æ—¥å¿—åˆ—è¡¨é¡µé¢ï¼Œå¯ä»¥é€šè¿‡æ ‡ç­¾ã€è§„åˆ™åç§°ã€å…³é”®è¯ã€æ—¶é—´èŒƒå›´ç­‰æ¡ä»¶ç­›é€‰æ—¥å¿—
   - æ”¯æŒåˆ†é¡µæµè§ˆå’Œæ¯é¡µæ•°é‡è°ƒæ•´

3. **æŸ¥çœ‹æŒ‡æ ‡**ï¼š
   - åœ¨æŒ‡æ ‡ç»Ÿè®¡é¡µé¢ï¼Œå¯ä»¥æŸ¥çœ‹å„é¡¹ç›®çš„æŒ‡æ ‡æ•°æ®
   - ç‚¹å‡»å±•å¼€æŒ‰é’®å¯ä»¥æŸ¥çœ‹è¯¦ç»†çš„è§„åˆ™è®¡æ•°ä¿¡æ¯

4. **è®¡è´¹ç»Ÿè®¡**ï¼šåœ¨è®¡è´¹ç»Ÿè®¡é¡µé¢å¯é…ç½®è®¡è´¹è§„åˆ™ã€æŸ¥çœ‹æŒ‰æ—¥èšåˆè®¡è´¹æ•°æ®

5. **æ ‡ç­¾ç®¡ç†**ï¼š
   - ç³»ç»Ÿä¼šè‡ªåŠ¨ä»ä¸ŠæŠ¥çš„æ—¥å¿—ä¸­æå–æ ‡ç­¾
   - é€šè¿‡æ ‡ç­¾å¯ä»¥å¿«é€Ÿç­›é€‰ç‰¹å®šé¡¹ç›®çš„æ—¥å¿—å’ŒæŒ‡æ ‡

## å¼€å‘è¯´æ˜

### åç«¯æŠ€æœ¯æ ˆ
- Go 1.21+
- Gin (Web æ¡†æ¶)
- GORM (ORM æ¡†æ¶)
- SQLite (æ•°æ®åº“)

### å‰ç«¯æŠ€æœ¯æ ˆ
- React 18
- Ant Design 5
- React Router 6
- Axios
- Day.js

## è®¸å¯è¯

MIT License
